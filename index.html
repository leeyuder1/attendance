<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿé»åç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .search-panel {
            background: linear-gradient(135deg, #f0f4ff 0%, #e7f0ff 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #667eea;
        }

        .search-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 15px;
        }

        .search-results {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .search-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }

        .search-result-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .search-result-item:last-child {
            margin-bottom: 0;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 5px;
        }

        .search-result-details {
            font-size: 0.9em;
            color: #666;
        }

        .search-result-status {
            margin-left: 15px;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .search-result-status.present {
            background: #d4edda;
            color: #155724;
        }

        .search-result-status.absent {
            background: #f8d7da;
            color: #721c24;
        }

        .search-result-status.none {
            background: #e2e3e5;
            color: #383d41;
        }

        .search-result-actions {
            display: flex;
            gap: 10px;
            margin-left: 15px;
        }

        .control-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-group label {
            font-weight: bold;
            color: #333;
            white-space: nowrap;
        }

        input[type="date"],
        input[type="text"],
        input[type="number"],
        select,
        button {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input[type="number"] {
            width: 80px;
        }

        input[type="date"]:focus,
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .section-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .seat-config {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
        }

        .seat-config h3 {
            margin-bottom: 10px;
            color: #856404;
        }

        .seat-grid-container {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            margin-top: 20px;
            overflow: auto;
            position: relative;
            transform-origin: top center;
            transition: transform 0.3s ease;
        }

        .zoom-controls {
            position: sticky;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 100;
            margin-bottom: 10px;
        }

        .zoom-controls label {
            font-weight: bold;
            color: #333;
            white-space: nowrap;
        }

        .zoom-slider {
            width: 150px;
            cursor: pointer;
        }

        .zoom-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
        }

        .zoom-btn {
            padding: 5px 12px;
            font-size: 14px;
            min-width: auto;
        }

        .seat-grid {
            display: inline-grid;
            gap: 10px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .seat-cell {
            width: 120px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            position: relative;
            transition: all 0.3s;
            min-height: 100px;
        }

        .seat-cell.dragover {
            border-color: #667eea;
            background: #e7f0ff;
            transform: scale(1.05);
            border-style: solid;
            border-width: 3px;
        }

        .seat-cell.has-student {
            border: 2px solid #667eea;
            background: white;
        }

        .student-seat-card {
            width: 100%;
            height: 100%;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 8px;
            cursor: move;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            position: relative;
        }

        .delete-student-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            z-index: 20;
            line-height: 1;
            padding: 0;
        }

        .delete-student-btn:hover {
            background: #c82333;
            transform: scale(1.2);
        }

        .student-seat-card:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            z-index: 10;
        }

        .student-seat-card.dragging {
            opacity: 0.5;
        }

        .student-seat-card.present {
            border-color: #28a745;
            background: #d4edda;
        }

        .student-seat-card.absent {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .seat-number {
            font-size: 0.7em;
            color: #999;
            margin-bottom: 2px;
        }

        .seat-name {
            font-weight: bold;
            font-size: 0.9em;
            color: #333;
            margin-bottom: 4px;
        }

        .seat-status {
            font-size: 0.75em;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 2px;
        }

        .seat-status.present {
            background: #28a745;
            color: white;
        }

        .seat-status.absent {
            background: #dc3545;
            color: white;
        }

        .unassigned-students {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .unassigned-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            min-height: 60px;
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .unassigned-list.dragover {
            background: #e7f0ff;
            border: 2px dashed #667eea;
        }

        .unassigned-card {
            padding: 12px 18px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: move;
            transition: all 0.3s;
            user-select: none;
            font-weight: 500;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .unassigned-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .unassigned-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .unassigned-delete-btn {
            width: 24px;
            height: 24px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
            line-height: 1;
            padding: 0;
        }

        .unassigned-delete-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }

        #studentRecordModal {
            z-index: 2000; /* ç¢ºä¿åœ¨è«‹å‡åå–®æ¨¡æ…‹æ¡†ä¹‹ä¸Š */
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
            font-size: 1.5em;
        }

        .attendance-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .attendance-option-btn {
            padding: 30px 20px;
            border: 3px solid #ddd;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .attendance-option-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .attendance-option-btn.present-option:hover {
            border-color: #28a745;
            background: #d4edda;
        }

        .attendance-option-btn.absent-option:hover {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .option-icon {
            font-size: 3em;
            font-weight: bold;
        }

        .present-option .option-icon {
            color: #28a745;
        }

        .absent-option .option-icon {
            color: #dc3545;
        }

        .option-label {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .leave-type-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .leave-type-btn {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            color: #333;
        }

        .leave-type-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
        }

        .leave-type-btn.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .other-leave-input {
            margin-top: 15px;
            display: none;
        }

        #currentStatusInfo {
            font-size: 1em;
            color: #333;
        }

        #clearRecordBtn button {
            padding: 12px;
            font-size: 16px;
        }

        .period-buttons {
            margin-top: 10px;
        }

        .period-btn {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .period-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
            color: #333;
        }

        .period-btn.selected {
            border-color: #667eea;
            background: #667eea;
            color: white !important;
            transform: scale(1.05);
        }

        .other-leave-input.show {
            display: block;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .modal-actions button {
            min-width: 100px;
        }

        .empty-seat {
            color: #999;
            font-size: 0.8em;
        }

        @media (max-width: 768px) {
            .control-panel {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
            }

            .seat-cell {
                width: 100px;
                height: 80px;
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“‹ å­¸ç”Ÿé»åç³»çµ±</h1>
            <p>è¼•é¬†ç®¡ç†å­¸ç”Ÿå‡ºå‹¤èˆ‡è«‹å‡è¨˜éŒ„</p>
        </div>

        <div class="content">
            <!-- æœå°‹å€åŸŸ -->
            <div class="search-panel">
                <h3 style="margin-bottom: 15px; color: #333;">ğŸ” å¿«é€Ÿæœå°‹èˆ‡è«‹å‡</h3>
                <div class="search-controls">
                    <div class="control-group">
                        <label for="searchDate">æœå°‹æ—¥æœŸï¼š</label>
                        <input type="date" id="searchDate">
                    </div>
                    <div class="control-group">
                        <label for="searchInput">æœå°‹å­¸ç”Ÿï¼ˆå§“åæˆ–åº§è™Ÿï¼‰ï¼š</label>
                        <input type="text" id="searchInput" placeholder="è¼¸å…¥å§“åæˆ–åº§è™Ÿ">
                    </div>
                    <button id="searchBtn" onclick="searchStudents()" class="btn-success">ğŸ” æœå°‹</button>
                    <button id="clearSearchBtn" onclick="clearSearch()" class="btn-danger">æ¸…é™¤</button>
                </div>
                <div id="searchResults" class="search-results" style="display: none;"></div>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <div class="control-group">
                    <label for="studentName">å§“åï¼š</label>
                    <input type="text" id="studentName" placeholder="å­¸ç”Ÿå§“å">
                </div>
                <div class="control-group">
                    <label for="studentNumber">åº§è™Ÿï¼š</label>
                    <input type="number" id="studentNumber" placeholder="åº§è™Ÿ" min="1">
                </div>
                <button onclick="addStudent()" class="btn-success">â• æ–°å¢å­¸ç”Ÿ</button>
                
                <div class="control-group">
                    <label for="selectedDate">æ—¥æœŸï¼š</label>
                    <input type="date" id="selectedDate">
                </div>

                <div class="control-group">
                    <label for="rows">è¡Œæ•¸ï¼š</label>
                    <input type="number" id="rows" placeholder="è¡Œ" min="1" max="20" value="6">
                </div>
                <div class="control-group">
                    <label for="cols">åˆ—æ•¸ï¼š</label>
                    <input type="number" id="cols" placeholder="åˆ—" min="1" max="20" value="6">
                </div>
                <button onclick="setupSeats()">ğŸª‘ è¨­å®šåº§ä½</button>
            </div>

            <!-- çµ±è¨ˆè³‡è¨Š -->
            <div class="stats" id="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">ç¸½å­¸ç”Ÿæ•¸</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="presentCount">0</div>
                    <div class="stat-label">ä»Šæ—¥å‡ºå¸­</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="absentCount">0</div>
                    <div class="stat-label">ä»Šæ—¥è«‹å‡</div>
                </div>
            </div>

            <!-- åº§ä½é…ç½® -->
            <div class="seat-config" id="seatConfig" style="display: none;">
                <h3>ğŸª‘ åº§ä½é…ç½®</h3>
                <div class="zoom-controls">
                    <label>ç¸®æ”¾ï¼š</label>
                    <input type="range" id="zoomSlider" class="zoom-slider" min="30" max="150" value="100" step="5">
                    <span class="zoom-value" id="zoomValue">100%</span>
                    <button class="zoom-btn" onclick="resetZoom()">é‡ç½®</button>
                    <button class="zoom-btn" onclick="fitToScreen()">é©æ‡‰è¢å¹•</button>
                </div>
                <div class="seat-grid-container" id="seatGridContainer">
                    <div class="seat-grid" id="seatGrid"></div>
                </div>
            </div>

            <!-- æœªåˆ†é…åº§ä½çš„å­¸ç”Ÿ -->
            <div class="unassigned-students" id="unassignedStudents" style="display: none;">
                <h3 class="section-title">æœªåˆ†é…åº§ä½</h3>
                <div class="unassigned-list" id="unassignedList"></div>
            </div>
        </div>
    </div>

    <!-- å‡ºå‹¤é¸æ“‡æ¨¡æ…‹æ¡† -->
    <div class="modal" id="attendanceModal">
        <div class="modal-content">
            <h3 id="attendanceModalTitle">é¸æ“‡å‡ºå‹¤ç‹€æ…‹</h3>
            <div id="currentStatusInfo" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; text-align: center; display: none;"></div>
            <div class="attendance-options">
                <button class="attendance-option-btn present-option" onclick="selectAttendance('present')">
                    <div class="option-icon">âœ“</div>
                    <div class="option-label">å‡ºå¸­</div>
                </button>
                <button class="attendance-option-btn absent-option" onclick="selectAttendance('absent')">
                    <div class="option-icon">âœ—</div>
                    <div class="option-label">è«‹å‡</div>
                </button>
            </div>
            <div id="clearRecordBtn" style="margin-top: 15px; display: none;">
                <button onclick="clearAttendanceRecord()" class="btn-danger" style="width: 100%;">æ¸…é™¤è¨˜éŒ„</button>
            </div>
            <div class="modal-actions">
                <button onclick="closeAttendanceModal()" class="btn-danger" style="width: 100%;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å‡åˆ¥é¸æ“‡æ¨¡æ…‹æ¡† -->
    <div class="modal" id="leaveTypeModal">
        <div class="modal-content">
            <h3>é¸æ“‡å‡åˆ¥</h3>
            <div class="leave-type-buttons">
                <button class="leave-type-btn" onclick="selectLeaveType('sick')">ç—…å‡</button>
                <button class="leave-type-btn" onclick="selectLeaveType('personal')">äº‹å‡</button>
                <button class="leave-type-btn" onclick="selectLeaveType('family')">å®¶åº­å› ç´ å‡</button>
                <button class="leave-type-btn" onclick="selectLeaveType('other')">å…¶ä»–</button>
            </div>
            <div class="other-leave-input" id="otherLeaveInput">
                <label>è«‹è¼¸å…¥å‡åˆ¥èªªæ˜ï¼š</label>
                <input type="text" id="otherLeaveText" placeholder="è¼¸å…¥å‡åˆ¥èªªæ˜" style="width: 100%; margin-top: 5px;">
            </div>
            <div class="period-selection" style="margin-top: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">é¸æ“‡è«‹å‡ç¯€æ¬¡ï¼ˆå¯å¤šé¸ï¼‰ï¼š</label>
                <div style="margin-bottom: 10px;">
                    <button id="allDayBtn" class="period-btn all-day-btn" onclick="selectAllDay()" style="width: 100%; padding: 12px; font-weight: bold; background: #fff3cd; border-color: #ffc107; color: #856404;">
                        å…¨å¤©è«‹å‡
                    </button>
                </div>
                <div class="period-buttons" id="periodButtons" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                    <!-- ç¯€æ¬¡æŒ‰éˆ•å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                </div>
                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    å·²é¸æ“‡ï¼š<span id="selectedPeriodsText">ç„¡</span>
                </div>
            </div>
            <div class="modal-actions">
                <button onclick="confirmLeaveType()" class="btn-success">ç¢ºèª</button>
                <button onclick="cancelLeaveType()" class="btn-danger">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å­¸ç”Ÿè¨˜éŒ„æŸ¥çœ‹æ¨¡æ…‹æ¡† -->
    <div class="modal" id="studentRecordModal">
        <div class="modal-content" style="max-width: 700px;">
            <h3 id="studentRecordTitle">å­¸ç”Ÿå‡ºç¼ºå¸­è¨˜éŒ„</h3>
            <div id="studentRecordContent" style="max-height: 500px; overflow-y: auto;">
                <!-- è¨˜éŒ„å…§å®¹å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div class="modal-actions">
                <button onclick="closeStudentRecord()" class="btn-danger" style="width: 100%;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- è«‹å‡åå–®æ¨¡æ…‹æ¡† -->
    <div class="modal" id="absentListModal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="absentListTitle">è«‹å‡åå–®</h3>
            <div id="absentListContent" style="max-height: 400px; overflow-y: auto;">
                <!-- è«‹å‡åå–®å…§å®¹å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div class="modal-actions">
                <button onclick="closeAbsentList()" class="btn-danger" style="width: 100%;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script>
        // ========== Firebase è¨­å®šå€ ==========
        // è«‹å°‡ä»¥ä¸‹è¨­å®šæ›¿æ›ç‚ºæ‚¨çš„ Firebase è¨­å®š
        // è©³ç´°èªªæ˜è«‹åƒè€ƒ FIREBASE_SETUP.md
        let USE_FIREBASE = true; // è¨­ç‚º true å•Ÿç”¨ Firebaseï¼Œfalse å‰‡ä½¿ç”¨ localStorage
        
        let db = null;
        if (USE_FIREBASE) {
            const firebaseConfig = {
                // TODO: è«‹æ›¿æ›ç‚ºæ‚¨çš„ Firebase è¨­å®š
                apiKey: "AIzaSyBfgQhkccwSBqPcfOYp8QUR7RuvG9unKIc",
                authDomain: "attendancesystem-yuderlee.firebaseapp.com",
                projectId: "attendancesystem-yuderlee",
                storageBucket: "attendancesystem-yuderlee.firebasestorage.app",
                messagingSenderId: "894483934672",
                appId: "1:894483934672:web:8b682215c90545e87f5dd5",
                measurementId: "G-NPEVXTF5V9"

            };
            
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log('Firebase åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('Firebase åˆå§‹åŒ–å¤±æ•—:', error);
                USE_FIREBASE = false;
            }
        }
        // ========== Firebase è¨­å®šå€çµæŸ ==========

        // åˆå§‹åŒ–ï¼šè¨­å®šä»Šå¤©ç‚ºé è¨­æ—¥æœŸ
        document.getElementById('selectedDate').valueAsDate = new Date();
        document.getElementById('searchDate').valueAsDate = new Date();

        // å¾ localStorage æˆ– Firebase è¼‰å…¥æ•¸æ“š
        let students = [];
        let attendance = {};
        let seatLayout = { rows: 6, cols: 6, seats: {} };
        let dataLoaded = false;
        let draggingStudent = null;
        let currentLeaveStudent = null;
        let selectedLeaveType = null;
        let otherLeaveText = '';
        let selectedPeriods = []; // é¸ä¸­çš„ç¯€æ¬¡

        // å‡åˆ¥é¸é …
        const leaveTypes = {
            'sick': 'ç—…å‡',
            'personal': 'äº‹å‡',
            'family': 'å®¶åº­å› ç´ å‡',
            'other': 'å…¶ä»–'
        };

        // æ–°å¢å­¸ç”Ÿ
        function addStudent() {
            const nameInput = document.getElementById('studentName');
            const numberInput = document.getElementById('studentNumber');
            const name = nameInput.value.trim();
            const number = parseInt(numberInput.value);

            if (!name) {
                alert('è«‹è¼¸å…¥å­¸ç”Ÿå§“åï¼');
                return;
            }

            if (!number || number < 1) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åº§è™Ÿï¼');
                return;
            }

            if (students.find(s => s.name === name)) {
                alert('è©²å­¸ç”Ÿå·²å­˜åœ¨ï¼');
                return;
            }

            if (students.find(s => s.number === number)) {
                alert('è©²åº§è™Ÿå·²è¢«ä½¿ç”¨ï¼');
                return;
            }

            students.push({
                name: name,
                number: number,
                row: null,
                col: null
            });

            saveStudents();
            nameInput.value = '';
            numberInput.value = '';
            renderSeats();
            updateStats();
        }

        // åˆªé™¤å­¸ç”Ÿ
        function deleteStudent(studentName) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤å­¸ç”Ÿã€Œ${studentName}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œå°‡åŒæ™‚åˆªé™¤è©²å­¸ç”Ÿçš„æ‰€æœ‰å‡ºå‹¤è¨˜éŒ„ã€‚`)) {
                return;
            }

            // å¾å­¸ç”Ÿåˆ—è¡¨ä¸­ç§»é™¤
            students = students.filter(s => s.name !== studentName);

            // åˆªé™¤è©²å­¸ç”Ÿçš„æ‰€æœ‰å‡ºå‹¤è¨˜éŒ„
            Object.keys(attendance).forEach(date => {
                if (attendance[date][studentName]) {
                    delete attendance[date][studentName];
                }
            });

            saveStudents();
            saveAttendance();
            renderSeats();
            updateStats();
        }

        // è¨­å®šåº§ä½
        function setupSeats() {
            const rows = parseInt(document.getElementById('rows').value) || 6;
            const cols = parseInt(document.getElementById('cols').value) || 6;

            if (rows < 1 || cols < 1 || rows > 20 || cols > 20) {
                alert('è¡Œæ•¸å’Œåˆ—æ•¸å¿…é ˆåœ¨ 1-20 ä¹‹é–“ï¼');
                return;
            }

            seatLayout.rows = rows;
            seatLayout.cols = cols;
            if (!seatLayout.seats) {
                seatLayout.seats = {};
            }

            saveSeatLayout();
            renderSeats();
        }

        // æ¸²æŸ“åº§ä½
        function renderSeats() {
            const seatGrid = document.getElementById('seatGrid');
            const seatConfig = document.getElementById('seatConfig');
            const unassignedStudents = document.getElementById('unassignedStudents');
            const unassignedList = document.getElementById('unassignedList');

            if (seatLayout.rows && seatLayout.cols) {
                seatConfig.style.display = 'block';
                seatGrid.style.gridTemplateColumns = `repeat(${seatLayout.cols}, 1fr)`;
                seatGrid.innerHTML = '';

                // å»ºç«‹åº§ä½ç¶²æ ¼
                for (let row = 0; row < seatLayout.rows; row++) {
                    for (let col = 0; col < seatLayout.cols; col++) {
                        const seatKey = `${row}-${col}`;
                        const seatCell = document.createElement('div');
                        seatCell.className = 'seat-cell';
                        seatCell.dataset.row = row;
                        seatCell.dataset.col = col;

                        // æ‰¾åˆ°é€™å€‹åº§ä½çš„å­¸ç”Ÿ
                        const student = students.find(s => s.row === row && s.col === col);
                        
                        if (student) {
                            seatCell.classList.add('has-student');
                            const date = document.getElementById('selectedDate').value;
                            const todayRecord = date && attendance[date] ? attendance[date][student.name] : null;
                            const isPresent = todayRecord?.status === 'present';
                            const isAbsent = todayRecord?.status === 'absent';
                            let leaveInfo = '';
                            if (isAbsent) {
                                leaveInfo = todayRecord.leaveTypeLabel || 'å…¶ä»–';
                                if (todayRecord.periodsText) {
                                    leaveInfo += ` (${todayRecord.periodsText})`;
                                }
                            }

                            const card = document.createElement('div');
                            card.className = `student-seat-card ${isPresent ? 'present' : ''} ${isAbsent ? 'absent' : ''}`;
                            card.draggable = true;
                            card.dataset.studentName = student.name;

                            card.innerHTML = `
                                <button class="delete-student-btn" onclick="event.stopPropagation(); deleteStudent('${student.name}')" title="åˆªé™¤å­¸ç”Ÿ">Ã—</button>
                                <div class="seat-number">åº§è™Ÿ ${student.number}</div>
                                <div class="seat-name" style="cursor: pointer; text-decoration: underline;" onclick="event.stopPropagation(); showStudentRecord('${student.name}')" title="é»æ“ŠæŸ¥çœ‹å‡ºç¼ºå¸­è¨˜éŒ„">${student.name}</div>
                                ${date ? `
                                    ${isPresent ? '<div class="seat-status present">âœ“ å‡ºå¸­</div>' : ''}
                                    ${isAbsent ? `<div class="seat-status absent">âœ— ${leaveInfo}</div>` : ''}
                                    ${!isPresent && !isAbsent ? '<div style="font-size: 0.7em; color: #999;">æœªè¨˜éŒ„</div>' : ''}
                                ` : ''}
                            `;

                            card.addEventListener('click', (e) => {
                                // å¦‚æœé»æ“Šçš„æ˜¯å§“åæˆ–åˆªé™¤æŒ‰éˆ•ï¼Œä¸è§¸ç™¼å‡ºå‹¤é¸é …
                                if (e.target.classList.contains('seat-name') || e.target.classList.contains('delete-student-btn')) {
                                    return;
                                }
                                if (date) {
                                    showAttendanceOptions(student.name);
                                }
                            });

                            card.addEventListener('dragstart', (e) => {
                                draggingStudent = student.name;
                                card.classList.add('dragging');
                                e.dataTransfer.effectAllowed = 'move';
                                e.dataTransfer.setData('text/plain', student.name);
                            });

                            card.addEventListener('dragend', () => {
                                draggingStudent = null;
                                card.classList.remove('dragging');
                            });

                            seatCell.appendChild(card);
                        } else {
                            seatCell.innerHTML = '<div class="empty-seat">ç©ºä½</div>';
                        }

                        // æ‹–æ”¾äº‹ä»¶
                        seatCell.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            seatCell.classList.add('dragover');
                        });

                        seatCell.addEventListener('dragleave', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            seatCell.classList.remove('dragover');
                        });

                        seatCell.addEventListener('drop', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            seatCell.classList.remove('dragover');
                            
                            // å¾ dataTransfer æˆ–å…¨å±€è®Šæ•¸ç²å–å­¸ç”Ÿåç¨±
                            const studentName = e.dataTransfer.getData('text/plain') || draggingStudent;
                            
                            if (studentName) {
                                const student = students.find(s => s.name === studentName);
                                if (student) {
                                    const newRow = parseInt(seatCell.dataset.row);
                                    const newCol = parseInt(seatCell.dataset.col);
                                    
                                    // æª¢æŸ¥æ–°ä½ç½®æ˜¯å¦å·²æœ‰å­¸ç”Ÿ
                                    const existingStudent = students.find(s => s.row === newRow && s.col === newCol && s.name !== student.name);
                                    if (existingStudent) {
                                        // äº¤æ›ä½ç½®
                                        const tempRow = student.row;
                                        const tempCol = student.col;
                                        student.row = newRow;
                                        student.col = newCol;
                                        existingStudent.row = tempRow;
                                        existingStudent.col = tempCol;
                                    } else {
                                        student.row = newRow;
                                        student.col = newCol;
                                    }
                                    
                                    saveStudents();
                                    renderSeats();
                                }
                            }
                        });

                        seatGrid.appendChild(seatCell);
                    }
                }
            } else {
                seatConfig.style.display = 'none';
            }

            // é¡¯ç¤ºæœªåˆ†é…åº§ä½çš„å­¸ç”Ÿï¼ˆæ‰€æœ‰æ²’æœ‰åº§ä½çš„å­¸ç”Ÿï¼‰
            // å¦‚æœæ²’æœ‰è¨­å®šåº§ä½ï¼Œæ‰€æœ‰å­¸ç”Ÿéƒ½è¦–ç‚ºæœªåˆ†é…
            let unassigned = [];
            if (!seatLayout.rows || !seatLayout.cols) {
                // æ²’æœ‰è¨­å®šåº§ä½æ™‚ï¼Œé¡¯ç¤ºæ‰€æœ‰å­¸ç”Ÿ
                unassigned = [...students];
            } else {
                // æœ‰è¨­å®šåº§ä½æ™‚ï¼Œåªé¡¯ç¤ºæ²’æœ‰è¢«åˆ†é…åˆ°æœ‰æ•ˆåº§ä½çš„å­¸ç”Ÿ
                students.forEach(s => {
                    let isAssigned = false;
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„åº§ä½åˆ†é…
                    if (s.row !== null && s.row !== undefined && 
                        s.col !== null && s.col !== undefined) {
                        // æª¢æŸ¥æ˜¯å¦åœ¨æœ‰æ•ˆç¯„åœå…§
                        if (s.row >= 0 && s.row < seatLayout.rows && 
                            s.col >= 0 && s.col < seatLayout.cols) {
                            isAssigned = true;
                        }
                    }
                    
                    // å¦‚æœæ²’æœ‰è¢«åˆ†é…ï¼ŒåŠ å…¥æœªåˆ†é…åˆ—è¡¨
                    if (!isAssigned) {
                        unassigned.push(s);
                    }
                });
            }
            
            // é¡¯ç¤ºæœªåˆ†é…å€åŸŸï¼ˆåªè¦æœ‰å­¸ç”Ÿå­˜åœ¨å°±é¡¯ç¤ºï¼Œä»¥ä¾¿æ¥æ”¶æ‹–æ”¾ï¼‰
            if (students.length > 0) {
                unassignedStudents.style.display = 'block';
                unassignedList.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
                
                // å¦‚æœæ²’æœ‰æœªåˆ†é…çš„å­¸ç”Ÿï¼Œé¡¯ç¤ºæç¤ºæ–‡å­—
                if (unassigned.length === 0) {
                    const hint = document.createElement('div');
                    hint.style.cssText = 'color: #999; font-style: italic; padding: 20px; text-align: center; width: 100%; pointer-events: none;';
                    hint.textContent = 'å¯å°‡åº§ä½ä¸Šçš„å­¸ç”Ÿæ‹–æ›³åˆ°æ­¤è™•ç§»é™¤åº§ä½åˆ†é…';
                    unassignedList.appendChild(hint);
                }
                
                // é¡¯ç¤ºæœªåˆ†é…çš„å­¸ç”Ÿ
                unassigned.forEach(student => {
                    const card = document.createElement('div');
                    card.className = 'unassigned-card';
                    card.draggable = true;
                    card.dataset.studentName = student.name;

                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = `${student.name} (åº§è™Ÿ ${student.number})`;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'unassigned-delete-btn';
                    deleteBtn.textContent = 'Ã—';
                    deleteBtn.title = 'åˆªé™¤å­¸ç”Ÿ';
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteStudent(student.name);
                    };

                    card.appendChild(nameSpan);
                    card.appendChild(deleteBtn);

                    card.addEventListener('dragstart', (e) => {
                        draggingStudent = student.name;
                        card.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', student.name);
                    });

                    card.addEventListener('dragend', () => {
                        draggingStudent = null;
                        card.classList.remove('dragging');
                    });

                    unassignedList.appendChild(card);
                });

                // ç‚ºæœªåˆ†é…å€åŸŸæ·»åŠ æ‹–æ”¾äº‹ä»¶ç›£è½å™¨ï¼ˆå…è¨±å°‡åº§ä½ä¸Šçš„å­¸ç”Ÿæ‹–å›ï¼‰
                unassignedList.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    unassignedList.classList.add('dragover');
                });

                unassignedList.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    // åªæœ‰ç•¶é›¢é–‹æ•´å€‹æœªåˆ†é…å€åŸŸæ™‚æ‰ç§»é™¤é«˜äº®
                    if (!unassignedList.contains(e.relatedTarget)) {
                        unassignedList.classList.remove('dragover');
                    }
                });

                unassignedList.addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    unassignedList.classList.remove('dragover');
                    
                    // å¾ dataTransfer æˆ–å…¨å±€è®Šæ•¸ç²å–å­¸ç”Ÿåç¨±
                    const studentName = e.dataTransfer.getData('text/plain') || draggingStudent;
                    
                    if (studentName) {
                        const student = students.find(s => s.name === studentName);
                        if (student) {
                            // æ¸…é™¤å­¸ç”Ÿçš„åº§ä½åˆ†é…
                            student.row = null;
                            student.col = null;
                            saveStudents();
                            renderSeats();
                        }
                    }
                });
            } else {
                unassignedStudents.style.display = 'none';
            }
        }

        // é¡¯ç¤ºå‡ºå‹¤é¸é …
        function showAttendanceOptions(studentName) {
            const date = document.getElementById('selectedDate').value;
            if (!date) {
                alert('è«‹å…ˆé¸æ“‡æ—¥æœŸï¼');
                return;
            }

            currentLeaveStudent = studentName;
            document.getElementById('attendanceModalTitle').textContent = `é¸æ“‡ã€Œ${studentName}ã€çš„å‡ºå‹¤ç‹€æ…‹`;
            
            // æª¢æŸ¥ç•¶å‰æ˜¯å¦æœ‰è¨˜éŒ„
            const statusInfo = document.getElementById('currentStatusInfo');
            const clearBtn = document.getElementById('clearRecordBtn');
            const todayRecord = attendance[date] ? attendance[date][studentName] : null;
            
            if (todayRecord) {
                if (todayRecord.status === 'present') {
                    statusInfo.innerHTML = '<strong>ç›®å‰ç‹€æ…‹ï¼š</strong><span style="color: #28a745; font-weight: bold;">âœ“ å‡ºå¸­</span>';
                    statusInfo.style.display = 'block';
                    clearBtn.style.display = 'block';
                } else if (todayRecord.status === 'absent') {
                    let leaveText = todayRecord.leaveTypeLabel || 'å…¶ä»–';
                    if (todayRecord.periodsText) {
                        leaveText += ` (${todayRecord.periodsText})`;
                    }
                    statusInfo.innerHTML = `<strong>ç›®å‰ç‹€æ…‹ï¼š</strong><span style="color: #dc3545; font-weight: bold;">âœ— è«‹å‡ - ${leaveText}</span>`;
                    statusInfo.style.display = 'block';
                    clearBtn.style.display = 'block';
                }
            } else {
                statusInfo.style.display = 'none';
                clearBtn.style.display = 'none';
            }
            
            document.getElementById('attendanceModal').classList.add('show');
        }

        // é¸æ“‡å‡ºå‹¤ç‹€æ…‹
        function selectAttendance(status) {
            document.getElementById('attendanceModal').classList.remove('show');
            
            if (status === 'present') {
                recordAttendance(currentLeaveStudent, 'present');
            } else if (status === 'absent') {
                showLeaveTypeModal(currentLeaveStudent);
            }
        }

        // é—œé–‰å‡ºå‹¤é¸æ“‡æ¨¡æ…‹æ¡†
        function closeAttendanceModal() {
            document.getElementById('attendanceModal').classList.remove('show');
            currentLeaveStudent = null;
        }

        // æ¸…é™¤å‡ºå‹¤è¨˜éŒ„
        function clearAttendanceRecord() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ­¤å­¸ç”Ÿçš„å‡ºå‹¤è¨˜éŒ„å—ï¼Ÿ')) {
                return;
            }

            const date = document.getElementById('selectedDate').value;
            if (date && attendance[date] && attendance[date][currentLeaveStudent]) {
                delete attendance[date][currentLeaveStudent];
                saveAttendance();
                renderSeats();
                updateStats();
                closeAttendanceModal();
            }
        }

        // é¡¯ç¤ºå‡åˆ¥é¸æ“‡æ¨¡æ…‹æ¡†
        function showLeaveTypeModal(studentName) {
            currentLeaveStudent = studentName;
            selectedLeaveType = null;
            otherLeaveText = '';
            selectedPeriods = [];
            document.getElementById('leaveTypeModal').classList.add('show');
            document.getElementById('otherLeaveInput').classList.remove('show');
            document.getElementById('otherLeaveText').value = '';
            
            // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.leave-type-btn').forEach(btn => {
                btn.classList.remove('selected');
            });

            // é‡ç½®å…¨å¤©æŒ‰éˆ•ç‹€æ…‹
            const allDayBtn = document.getElementById('allDayBtn');
            if (allDayBtn) {
                allDayBtn.classList.remove('selected');
                allDayBtn.style.background = '#fff3cd';
                allDayBtn.style.color = '#856404';
            }

            // ç”Ÿæˆç¯€æ¬¡æŒ‰éˆ•
            const periodButtons = document.getElementById('periodButtons');
            periodButtons.innerHTML = '';
            for (let i = 1; i <= 11; i++) {
                const btn = document.createElement('button');
                btn.className = 'period-btn';
                btn.textContent = `ç¬¬${i}ç¯€`;
                btn.dataset.period = i;
                btn.onclick = () => togglePeriod(i);
                periodButtons.appendChild(btn);
            }
            updateSelectedPeriodsText();
        }

        // é¸æ“‡å…¨å¤©
        function selectAllDay() {
            // é¸æ“‡æ‰€æœ‰ç¯€æ¬¡ï¼ˆ1-11ï¼‰
            selectedPeriods = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
            
            // æ›´æ–°æ‰€æœ‰ç¯€æ¬¡æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.period-btn[data-period]').forEach(btn => {
                btn.classList.add('selected');
            });
            
            // æ›´æ–°å…¨å¤©æŒ‰éˆ•ç‹€æ…‹
            const allDayBtn = document.getElementById('allDayBtn');
            if (allDayBtn) {
                allDayBtn.classList.add('selected');
                allDayBtn.style.background = '#ffc107';
                allDayBtn.style.color = '#000';
            }
            
            updateSelectedPeriodsText();
        }

        // åˆ‡æ›ç¯€æ¬¡é¸æ“‡
        function togglePeriod(period) {
            const index = selectedPeriods.indexOf(period);
            if (index > -1) {
                selectedPeriods.splice(index, 1);
            } else {
                selectedPeriods.push(period);
            }
            selectedPeriods.sort((a, b) => a - b);
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const btn = document.querySelector(`.period-btn[data-period="${period}"]`);
            if (btn) {
                btn.classList.toggle('selected');
            }
            
            // å¦‚æœå–æ¶ˆä»»ä½•ç¯€æ¬¡ï¼Œå–æ¶ˆå…¨å¤©ç‹€æ…‹
            const allDayBtn = document.getElementById('allDayBtn');
            if (allDayBtn && selectedPeriods.length < 11) {
                allDayBtn.classList.remove('selected');
                allDayBtn.style.background = '#fff3cd';
                allDayBtn.style.color = '#856404';
            }
            
            // å¦‚æœé¸æ“‡äº†æ‰€æœ‰ç¯€æ¬¡ï¼Œè‡ªå‹•æ¨™è¨˜ç‚ºå…¨å¤©
            if (selectedPeriods.length === 11 && allDayBtn) {
                allDayBtn.classList.add('selected');
                allDayBtn.style.background = '#ffc107';
                allDayBtn.style.color = '#000';
            }
            
            updateSelectedPeriodsText();
        }

        // æ›´æ–°å·²é¸æ“‡ç¯€æ¬¡æ–‡å­—
        function updateSelectedPeriodsText() {
            const textEl = document.getElementById('selectedPeriodsText');
            if (selectedPeriods.length === 0) {
                textEl.textContent = 'ç„¡';
            } else if (selectedPeriods.length === 11) {
                textEl.textContent = 'å…¨å¤©';
            } else {
                textEl.textContent = selectedPeriods.map(p => `ç¬¬${p}ç¯€`).join('ã€');
            }
        }

        // é¸æ“‡å‡åˆ¥
        function selectLeaveType(type) {
            selectedLeaveType = type;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.leave-type-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');

            // å¦‚æœæ˜¯ã€Œå…¶ä»–ã€ï¼Œé¡¯ç¤ºè¼¸å…¥æ¡†
            if (type === 'other') {
                document.getElementById('otherLeaveInput').classList.add('show');
            } else {
                document.getElementById('otherLeaveInput').classList.remove('show');
                otherLeaveText = '';
            }
        }

        // ç¢ºèªå‡åˆ¥
        function confirmLeaveType() {
            if (!selectedLeaveType) {
                alert('è«‹é¸æ“‡å‡åˆ¥ï¼');
                return;
            }

            if (selectedPeriods.length === 0) {
                alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç¯€æ¬¡ï¼');
                return;
            }

            if (selectedLeaveType === 'other') {
                otherLeaveText = document.getElementById('otherLeaveText').value.trim();
                if (!otherLeaveText) {
                    alert('è«‹è¼¸å…¥å‡åˆ¥èªªæ˜ï¼');
                    return;
                }
            }

            recordAttendance(currentLeaveStudent, 'absent');
            document.getElementById('leaveTypeModal').classList.remove('show');
        }

        // å–æ¶ˆå‡åˆ¥é¸æ“‡
        function cancelLeaveType() {
            document.getElementById('leaveTypeModal').classList.remove('show');
            currentLeaveStudent = null;
            selectedLeaveType = null;
            otherLeaveText = '';
            selectedPeriods = [];
        }

        // è¨˜éŒ„å‡ºå‹¤ç‹€æ…‹
        function recordAttendance(studentName, status) {
            const date = document.getElementById('selectedDate').value;
            if (!date) {
                alert('è«‹å…ˆé¸æ“‡æ—¥æœŸï¼');
                return;
            }

            if (!attendance[date]) {
                attendance[date] = {};
            }

            if (status === 'present') {
                attendance[date][studentName] = { status: 'present' };
            } else if (status === 'absent') {
                let leaveTypeLabel = leaveTypes[selectedLeaveType] || 'å…¶ä»–';
                if (selectedLeaveType === 'other' && otherLeaveText) {
                    leaveTypeLabel = otherLeaveText;
                }
                
                // æ ¼å¼åŒ–ç¯€æ¬¡é¡¯ç¤º
                let periodsText = '';
                if (selectedPeriods.length === 11) {
                    periodsText = 'å…¨å¤©';
                } else if (selectedPeriods.length > 0) {
                    periodsText = selectedPeriods.map(p => `ç¬¬${p}ç¯€`).join('ã€');
                }
                
                attendance[date][studentName] = {
                    status: 'absent',
                    leaveType: selectedLeaveType || 'other',
                    leaveTypeLabel: leaveTypeLabel,
                    periods: [...selectedPeriods], // ä¿å­˜ç¯€æ¬¡é™£åˆ—
                    periodsText: periodsText, // ä¿å­˜ç¯€æ¬¡æ–‡å­—
                    isAllDay: selectedPeriods.length === 11 // æ¨™è¨˜æ˜¯å¦å…¨å¤©
                };
            }

            saveAttendance();
            renderSeats();
            updateStats();
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats() {
            const date = document.getElementById('selectedDate').value;
            document.getElementById('totalStudents').textContent = students.length;

            if (date && attendance[date]) {
                const records = attendance[date];
                const presentCount = Object.values(records).filter(r => r.status === 'present').length;
                const absentCount = Object.values(records).filter(r => r.status === 'absent').length;
                
                document.getElementById('presentCount').textContent = presentCount;
                
                // è®“è«‹å‡äººæ•¸å¯é»æ“ŠæŸ¥çœ‹
                const absentCountEl = document.getElementById('absentCount');
                absentCountEl.textContent = absentCount;
                if (absentCount > 0) {
                    absentCountEl.style.cursor = 'pointer';
                    absentCountEl.style.textDecoration = 'underline';
                    absentCountEl.style.color = '#dc3545';
                    absentCountEl.onclick = () => showAbsentList(date);
                    absentCountEl.title = 'é»æ“ŠæŸ¥çœ‹è«‹å‡åå–®';
                } else {
                    absentCountEl.style.cursor = 'default';
                    absentCountEl.style.textDecoration = 'none';
                    absentCountEl.onclick = null;
                    absentCountEl.title = '';
                }
            } else {
                document.getElementById('presentCount').textContent = '0';
                const absentCountEl = document.getElementById('absentCount');
                absentCountEl.textContent = '0';
                absentCountEl.style.cursor = 'default';
                absentCountEl.style.textDecoration = 'none';
                absentCountEl.onclick = null;
                absentCountEl.title = '';
            }
        }

        // é¡¯ç¤ºè«‹å‡åå–®
        function showAbsentList(date) {
            if (!date || !attendance[date]) {
                alert('è©²æ—¥æœŸæ²’æœ‰è«‹å‡è¨˜éŒ„');
                return;
            }

            const records = attendance[date];
            const absentStudents = Object.keys(records)
                .filter(name => records[name].status === 'absent')
                .map(name => {
                    const student = students.find(s => s.name === name);
                    const record = records[name];
                    return { student, record };
                })
                .filter(item => item.student) // éæ¿¾æ‰å·²åˆªé™¤çš„å­¸ç”Ÿ
                .sort((a, b) => a.student.number - b.student.number);

            if (absentStudents.length === 0) {
                alert('è©²æ—¥æœŸæ²’æœ‰è«‹å‡è¨˜éŒ„');
                return;
            }

            document.getElementById('absentListTitle').textContent = `${formatDate(date)} è«‹å‡åå–®`;
            const content = document.getElementById('absentListContent');
            content.innerHTML = absentStudents.map(({ student, record }) => {
                let leaveInfo = record.leaveTypeLabel || 'å…¶ä»–';
                if (record.periodsText) {
                    leaveInfo += ` (${record.periodsText})`;
                }
                // è½‰ç¾©å­¸ç”Ÿå§“åä¸­çš„å–®å¼•è™Ÿ
                const escapedName = student.name.replace(/'/g, "\\'");
                return `
                    <div class="search-result-item" style="cursor: pointer;" onclick="closeAbsentList(); setTimeout(() => showStudentRecord('${escapedName}'), 100);">
                        <div class="search-result-info">
                            <div class="search-result-name">${student.name}</div>
                            <div class="search-result-details">åº§è™Ÿï¼š${student.number} | å‡åˆ¥ï¼š${leaveInfo}</div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('absentListModal').classList.add('show');
        }

        // é—œé–‰è«‹å‡åå–®
        function closeAbsentList() {
            document.getElementById('absentListModal').classList.remove('show');
        }

        // é¡¯ç¤ºå­¸ç”Ÿè¨˜éŒ„
        function showStudentRecord(studentName) {
            const student = students.find(s => s.name === studentName);
            if (!student) {
                alert('æ‰¾ä¸åˆ°è©²å­¸ç”Ÿ');
                return;
            }

            document.getElementById('studentRecordTitle').textContent = `${student.name} (åº§è™Ÿ ${student.number}) çš„å‡ºç¼ºå¸­è¨˜éŒ„`;

            // æ”¶é›†æ‰€æœ‰è¨˜éŒ„
            const allRecords = [];
            Object.keys(attendance).sort().reverse().forEach(date => {
                const record = attendance[date][studentName];
                if (record) {
                    allRecords.push({ date, record });
                }
            });

            const content = document.getElementById('studentRecordContent');
            if (allRecords.length === 0) {
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">å°šç„¡å‡ºç¼ºå¸­è¨˜éŒ„</div>';
            } else {
                // è½‰ç¾©å­¸ç”Ÿå§“åä¸­çš„å–®å¼•è™Ÿ
                const escapedName = studentName.replace(/'/g, "\\'");
                
                content.innerHTML = allRecords.map(({ date, record }) => {
                    if (record.status === 'present') {
                        return `
                            <div class="search-result-item" style="cursor: pointer;" onclick="editStudentRecord('${escapedName}', '${date}')" title="é»æ“Šä¿®æ”¹æ­¤è¨˜éŒ„">
                                <div class="search-result-info">
                                    <div class="search-result-name">${formatDateWithWeekday(date)}</div>
                                    <div class="search-result-details">ç‹€æ…‹ï¼šå‡ºå¸­</div>
                                </div>
                                <div class="search-result-status present">âœ“ å‡ºå¸­</div>
                            </div>
                        `;
                    } else if (record.status === 'absent') {
                        let leaveInfo = record.leaveTypeLabel || 'å…¶ä»–';
                        if (record.periodsText) {
                            leaveInfo += ` (${record.periodsText})`;
                        }
                        return `
                            <div class="search-result-item" style="cursor: pointer;" onclick="editStudentRecord('${escapedName}', '${date}')" title="é»æ“Šä¿®æ”¹æ­¤è¨˜éŒ„">
                                <div class="search-result-info">
                                    <div class="search-result-name">${formatDateWithWeekday(date)}</div>
                                    <div class="search-result-details">å‡åˆ¥ï¼š${leaveInfo}</div>
                                </div>
                                <div class="search-result-status absent">âœ— è«‹å‡</div>
                            </div>
                        `;
                    }
                    return '';
                }).join('');
            }

            document.getElementById('studentRecordModal').classList.add('show');
        }

        // é—œé–‰å­¸ç”Ÿè¨˜éŒ„
        function closeStudentRecord() {
            document.getElementById('studentRecordModal').classList.remove('show');
        }

        // ç·¨è¼¯å­¸ç”Ÿè¨˜éŒ„
        function editStudentRecord(studentName, date) {
            // è¨­å®šæ—¥æœŸ
            document.getElementById('selectedDate').value = date;
            
            // é—œé–‰å­¸ç”Ÿè¨˜éŒ„æ¨¡æ…‹æ¡†
            closeStudentRecord();
            
            // ç¨ç­‰ä¸€ä¸‹è®“å‹•ç•«å®Œæˆï¼Œç„¶å¾Œæ‰“é–‹å‡ºå‹¤é¸æ“‡æ¨¡æ…‹æ¡†
            setTimeout(() => {
                showAttendanceOptions(studentName);
            }, 200);
        }

        // å„²å­˜å­¸ç”Ÿåˆ—è¡¨
        async function saveStudents() {
            // åŒæ™‚å„²å­˜åˆ° localStorageï¼ˆä½œç‚ºå‚™ä»½ï¼‰
            localStorage.setItem('students', JSON.stringify(students));
            
            // å¦‚æœä½¿ç”¨ Firebaseï¼Œä¹Ÿå„²å­˜åˆ°é›²ç«¯
            if (USE_FIREBASE && db) {
                try {
                    await db.collection('data').doc('students').set({ data: students });
                } catch (error) {
                    console.error('å„²å­˜å­¸ç”Ÿè³‡æ–™åˆ° Firebase å¤±æ•—:', error);
                }
            }
        }

        // å„²å­˜å‡ºå‹¤è¨˜éŒ„
        async function saveAttendance() {
            // åŒæ™‚å„²å­˜åˆ° localStorageï¼ˆä½œç‚ºå‚™ä»½ï¼‰
            localStorage.setItem('attendance', JSON.stringify(attendance));
            
            // å¦‚æœä½¿ç”¨ Firebaseï¼Œä¹Ÿå„²å­˜åˆ°é›²ç«¯
            if (USE_FIREBASE && db) {
                try {
                    await db.collection('data').doc('attendance').set({ data: attendance });
                } catch (error) {
                    console.error('å„²å­˜å‡ºå‹¤è¨˜éŒ„åˆ° Firebase å¤±æ•—:', error);
                }
            }
        }

        // å„²å­˜åº§ä½é…ç½®
        async function saveSeatLayout() {
            // åŒæ™‚å„²å­˜åˆ° localStorageï¼ˆä½œç‚ºå‚™ä»½ï¼‰
            localStorage.setItem('seatLayout', JSON.stringify(seatLayout));
            
            // å¦‚æœä½¿ç”¨ Firebaseï¼Œä¹Ÿå„²å­˜åˆ°é›²ç«¯
            if (USE_FIREBASE && db) {
                try {
                    await db.collection('data').doc('seatLayout').set({ data: seatLayout });
                } catch (error) {
                    console.error('å„²å­˜åº§ä½é…ç½®åˆ° Firebase å¤±æ•—:', error);
                }
            }
        }

        // å¾ Firebase è¼‰å…¥è³‡æ–™
        async function loadDataFromFirebase() {
            if (!USE_FIREBASE || !db) {
                // å¦‚æœä¸ä½¿ç”¨ Firebaseï¼Œå¾ localStorage è¼‰å…¥
                students = JSON.parse(localStorage.getItem('students')) || [];
                attendance = JSON.parse(localStorage.getItem('attendance')) || {};
                seatLayout = JSON.parse(localStorage.getItem('seatLayout')) || { rows: 6, cols: 6, seats: {} };
                dataLoaded = true;
                renderSeats();
                updateStats();
                return;
            }

            try {
                // å¾ Firebase è¼‰å…¥è³‡æ–™
                const studentsDoc = await db.collection('data').doc('students').get();
                const attendanceDoc = await db.collection('data').doc('attendance').get();
                const seatLayoutDoc = await db.collection('data').doc('seatLayout').get();

                if (studentsDoc.exists) {
                    students = studentsDoc.data().data || [];
                    // åŒæ­¥åˆ° localStorage
                    localStorage.setItem('students', JSON.stringify(students));
                } else {
                    // å¦‚æœ Firebase æ²’æœ‰è³‡æ–™ï¼Œå˜—è©¦å¾ localStorage è¼‰å…¥ä¸¦ä¸Šå‚³
                    students = JSON.parse(localStorage.getItem('students')) || [];
                    if (students.length > 0) {
                        await saveStudents();
                    }
                }

                if (attendanceDoc.exists) {
                    attendance = attendanceDoc.data().data || {};
                    // åŒæ­¥åˆ° localStorage
                    localStorage.setItem('attendance', JSON.stringify(attendance));
                } else {
                    attendance = JSON.parse(localStorage.getItem('attendance')) || {};
                    if (Object.keys(attendance).length > 0) {
                        await saveAttendance();
                    }
                }

                if (seatLayoutDoc.exists) {
                    seatLayout = seatLayoutDoc.data().data || { rows: 6, cols: 6, seats: {} };
                    // åŒæ­¥åˆ° localStorage
                    localStorage.setItem('seatLayout', JSON.stringify(seatLayout));
                } else {
                    seatLayout = JSON.parse(localStorage.getItem('seatLayout')) || { rows: 6, cols: 6, seats: {} };
                    if (seatLayout.rows && seatLayout.cols) {
                        await saveSeatLayout();
                    }
                }

                dataLoaded = true;
                renderSeats();
                updateStats();
                
                // ç›£è½è³‡æ–™è®Šæ›´ï¼ˆå³æ™‚åŒæ­¥ï¼‰
                db.collection('data').doc('students').onSnapshot((doc) => {
                    if (doc.exists && dataLoaded) {
                        const newStudents = doc.data().data || [];
                        if (JSON.stringify(newStudents) !== JSON.stringify(students)) {
                            students = newStudents;
                            localStorage.setItem('students', JSON.stringify(students));
                            renderSeats();
                            updateStats();
                        }
                    }
                });

                db.collection('data').doc('attendance').onSnapshot((doc) => {
                    if (doc.exists && dataLoaded) {
                        const newAttendance = doc.data().data || {};
                        if (JSON.stringify(newAttendance) !== JSON.stringify(attendance)) {
                            attendance = newAttendance;
                            localStorage.setItem('attendance', JSON.stringify(attendance));
                            renderSeats();
                            updateStats();
                        }
                    }
                });

                db.collection('data').doc('seatLayout').onSnapshot((doc) => {
                    if (doc.exists && dataLoaded) {
                        const newSeatLayout = doc.data().data || { rows: 6, cols: 6, seats: {} };
                        if (JSON.stringify(newSeatLayout) !== JSON.stringify(seatLayout)) {
                            seatLayout = newSeatLayout;
                            localStorage.setItem('seatLayout', JSON.stringify(seatLayout));
                            renderSeats();
                            updateStats();
                        }
                    }
                });

                console.log('è³‡æ–™è¼‰å…¥æˆåŠŸ');
            } catch (error) {
                console.error('å¾ Firebase è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œä½¿ç”¨ localStorage ä½œç‚ºå‚™ä»½
                students = JSON.parse(localStorage.getItem('students')) || [];
                attendance = JSON.parse(localStorage.getItem('attendance')) || {};
                seatLayout = JSON.parse(localStorage.getItem('seatLayout')) || { rows: 6, cols: 6, seats: {} };
                dataLoaded = true;
                renderSeats();
                updateStats();
            }
        }

        // åˆå§‹åŒ–æ™‚è¼‰å…¥è³‡æ–™
        loadDataFromFirebase();

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}å¹´${month}æœˆ${day}æ—¥`;
        }

        // æ ¼å¼åŒ–æ—¥æœŸï¼ˆåŒ…å«æ˜ŸæœŸå¹¾ï¼‰
        function formatDateWithWeekday(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const weekday = weekdays[date.getDay()];
            return `${year}å¹´${month}æœˆ${day}æ—¥ (${weekday})`;
        }

        // æœå°‹å­¸ç”Ÿ
        function searchStudents() {
            try {
                const searchDate = document.getElementById('searchDate').value;
                const searchInput = document.getElementById('searchInput').value.trim();
                const searchResults = document.getElementById('searchResults');

                if (!searchDate) {
                    alert('è«‹å…ˆé¸æ“‡æœå°‹æ—¥æœŸï¼');
                    return;
                }

                if (!searchInput) {
                    alert('è«‹è¼¸å…¥è¦æœå°‹çš„å­¸ç”Ÿå§“åæˆ–åº§è™Ÿï¼');
                    return;
                }

                // æª¢æŸ¥æ˜¯å¦æœ‰å­¸ç”Ÿè³‡æ–™
                if (!students || students.length === 0) {
                    searchResults.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">ç›®å‰æ²’æœ‰å­¸ç”Ÿè³‡æ–™ï¼Œè«‹å…ˆæ–°å¢å­¸ç”Ÿ</div>';
                    searchResults.style.display = 'block';
                    return;
                }

                // æœå°‹å­¸ç”Ÿï¼ˆæ ¹æ“šå§“åæˆ–åº§è™Ÿï¼‰
                const searchTerm = searchInput.toLowerCase();
                const matchedStudents = students.filter(s => {
                    if (!s || !s.name || s.number === undefined) return false;
                    const nameMatch = s.name.toLowerCase().includes(searchTerm);
                    const numberMatch = s.number.toString().includes(searchTerm);
                    return nameMatch || numberMatch;
                });

                if (matchedStudents.length === 0) {
                    searchResults.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æœªæ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„å­¸ç”Ÿ</div>';
                    searchResults.style.display = 'block';
                    return;
                }

            // é¡¯ç¤ºæœå°‹çµæœ
            searchResults.innerHTML = matchedStudents.map(student => {
                const todayRecord = attendance[searchDate] ? attendance[searchDate][student.name] : null;
                const isPresent = todayRecord?.status === 'present';
                const isAbsent = todayRecord?.status === 'absent';
                let leaveInfo = '';
                if (isAbsent) {
                    leaveInfo = todayRecord.leaveTypeLabel || 'å…¶ä»–';
                    if (todayRecord.periodsText) {
                        leaveInfo += ` (${todayRecord.periodsText})`;
                    }
                }
                let statusText = 'æœªè¨˜éŒ„';
                let statusClass = 'none';
                
                if (isPresent) {
                    statusText = 'âœ“ å‡ºå¸­';
                    statusClass = 'present';
                } else if (isAbsent) {
                    statusText = `âœ— è«‹å‡ - ${leaveInfo}`;
                    statusClass = 'absent';
                }

                // è½‰ç¾©å­¸ç”Ÿå§“åä¸­çš„å–®å¼•è™Ÿï¼Œé¿å… onclick éŒ¯èª¤
                const escapedName = student.name.replace(/'/g, "\\'");
                
                return `
                    <div class="search-result-item">
                        <div class="search-result-info">
                            <div class="search-result-name" style="cursor: pointer; text-decoration: underline;" onclick="showStudentRecord('${escapedName}')" title="é»æ“ŠæŸ¥çœ‹å‡ºç¼ºå¸­è¨˜éŒ„">${student.name}</div>
                            <div class="search-result-details">åº§è™Ÿï¼š${student.number} | æ—¥æœŸï¼š${formatDate(searchDate)}</div>
                        </div>
                        <div class="search-result-status ${statusClass}">${statusText}</div>
                        <div class="search-result-actions">
                            <button onclick="event.stopPropagation(); searchShowAttendance('${escapedName}', '${searchDate}')" class="btn-success" style="padding: 8px 15px; font-size: 14px;">ğŸ“ è¨˜éŒ„å‡ºå‹¤</button>
                        </div>
                    </div>
                `;
            }).join('');

                searchResults.style.display = 'block';
            } catch (error) {
                console.error('æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
                alert('æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°');
            }
        }

        // å¾æœå°‹çµæœé¡¯ç¤ºå‡ºå‹¤é¸é …
        function searchShowAttendance(studentName, date) {
            // è¨­å®šæœå°‹æ—¥æœŸç‚ºç•¶å‰é¸æ“‡çš„æ—¥æœŸ
            document.getElementById('selectedDate').value = date;
            // é¡¯ç¤ºå‡ºå‹¤é¸é …
            showAttendanceOptions(studentName);
            // é—œé–‰æœå°‹çµæœï¼ˆå¯é¸ï¼‰
            // document.getElementById('searchResults').style.display = 'none';
        }

        // æ¸…é™¤æœå°‹
        function clearSearch() {
            document.getElementById('searchDate').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').style.display = 'none';
        }

        // ç•¶æ—¥æœŸæ”¹è®Šæ™‚é‡æ–°è¼‰å…¥
        document.getElementById('selectedDate').addEventListener('change', function() {
            renderSeats();
            updateStats();
        });

        // å…è¨± Enter éµæ–°å¢å­¸ç”Ÿ
        document.getElementById('studentName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addStudent();
            }
        });

        document.getElementById('studentNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addStudent();
            }
        });

        // å…è¨± Enter éµåŸ·è¡Œæœå°‹
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStudents();
            }
        });

        // ç‚ºæœå°‹æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨ï¼ˆç¢ºä¿é»æ“Šèƒ½æ­£å¸¸å·¥ä½œï¼‰
        const searchBtn = document.getElementById('searchBtn');
        if (searchBtn) {
            searchBtn.addEventListener('click', function(e) {
                e.preventDefault();
                searchStudents();
            });
        }

        // ç‚ºæ¸…é™¤æŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', function(e) {
                e.preventDefault();
                clearSearch();
            });
        }

        // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
        document.getElementById('attendanceModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAttendanceModal();
            }
        });

        document.getElementById('leaveTypeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cancelLeaveType();
            }
        });

        document.getElementById('studentRecordModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeStudentRecord();
            }
        });

        document.getElementById('absentListModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAbsentList();
            }
        });

        // æ¸…ç†ç„¡æ•ˆçš„è«‹å‡è¨˜éŒ„ï¼ˆä¿®å¾©èˆŠæ•¸æ“šå•é¡Œï¼‰
        function cleanInvalidRecords() {
            Object.keys(attendance).forEach(date => {
                Object.keys(attendance[date]).forEach(studentName => {
                    const record = attendance[date][studentName];
                    // å¦‚æœè¨˜éŒ„ç‹€æ…‹æ˜¯ absent ä½†æ²’æœ‰ periods æˆ– periodsTextï¼Œå¯èƒ½æ˜¯èˆŠæ•¸æ“š
                    if (record.status === 'absent') {
                        // ç¢ºä¿æœ‰ periods å’Œ periodsTextï¼ˆå¦‚æœæ²’æœ‰ï¼Œè¨­ç‚ºç©ºï¼‰
                        if (!record.periods) {
                            record.periods = [];
                        }
                        if (!record.periodsText) {
                            record.periodsText = '';
                        }
                        // å¦‚æœæ²’æœ‰ leaveTypeLabelï¼Œè¨­ç‚ºé»˜èªå€¼
                        if (!record.leaveTypeLabel) {
                            record.leaveTypeLabel = 'å…¶ä»–';
                        }
                    }
                    // æª¢æŸ¥å­¸ç”Ÿæ˜¯å¦é‚„å­˜åœ¨
                    const studentExists = students.find(s => s.name === studentName);
                    if (!studentExists) {
                        delete attendance[date][studentName];
                    }
                });
            });
            saveAttendance();
        }

        // æ¸…ç†ç„¡æ•ˆè¨˜éŒ„ï¼ˆç­‰å¾…è³‡æ–™è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œï¼‰
        function initializeApp() {
            cleanInvalidRecords();
            // åˆå§‹åŒ–æ¸²æŸ“
            if (seatLayout.rows && seatLayout.cols) {
                document.getElementById('rows').value = seatLayout.rows;
                document.getElementById('cols').value = seatLayout.cols;
            }
            // renderSeats() å’Œ updateStats() æœƒåœ¨ loadDataFromFirebase() ä¸­å‘¼å«
        }
        
        // ç­‰å¾…è³‡æ–™è¼‰å…¥å®Œæˆ
        const checkDataLoaded = setInterval(() => {
            if (dataLoaded) {
                clearInterval(checkDataLoaded);
                initializeApp();
            }
        }, 100);

        // ========== ç¸®æ”¾åŠŸèƒ½ ==========
        let currentZoom = 100;
        
        // åˆå§‹åŒ–ç¸®æ”¾æ§åˆ¶ï¼ˆç­‰å¾… DOM è¼‰å…¥å®Œæˆï¼‰
        function initZoomControls() {
            const zoomSlider = document.getElementById('zoomSlider');
            const zoomValue = document.getElementById('zoomValue');
            const seatGridContainer = document.getElementById('seatGridContainer');

            if (!zoomSlider || !zoomValue || !seatGridContainer) {
                // å¦‚æœå…ƒç´ é‚„ä¸å­˜åœ¨ï¼Œç¨å¾Œå†è©¦
                setTimeout(initZoomControls, 100);
                return;
            }

            // å¾ localStorage è¼‰å…¥ä¸Šæ¬¡çš„ç¸®æ”¾è¨­å®š
            const savedZoom = localStorage.getItem('seatZoom');
            if (savedZoom) {
                currentZoom = parseInt(savedZoom);
                zoomSlider.value = currentZoom;
                zoomValue.textContent = currentZoom + '%';
                seatGridContainer.style.transform = `scale(${currentZoom / 100})`;
            }

            // ç›£è½ç¸®æ”¾æ»‘æ¡¿è®ŠåŒ–
            zoomSlider.addEventListener('input', function(e) {
                currentZoom = parseInt(e.target.value);
                zoomValue.textContent = currentZoom + '%';
                seatGridContainer.style.transform = `scale(${currentZoom / 100})`;
                // å„²å­˜ç¸®æ”¾è¨­å®š
                localStorage.setItem('seatZoom', currentZoom);
            });
        }

        // é‡ç½®ç¸®æ”¾
        function resetZoom() {
            const zoomSlider = document.getElementById('zoomSlider');
            const zoomValue = document.getElementById('zoomValue');
            const seatGridContainer = document.getElementById('seatGridContainer');
            
            if (zoomSlider && zoomValue && seatGridContainer) {
                currentZoom = 100;
                zoomSlider.value = currentZoom;
                zoomValue.textContent = currentZoom + '%';
                seatGridContainer.style.transform = `scale(1)`;
                localStorage.setItem('seatZoom', currentZoom);
            }
        }

        // é©æ‡‰è¢å¹•ï¼ˆè‡ªå‹•è¨ˆç®—é©åˆçš„ç¸®æ”¾æ¯”ä¾‹ï¼‰
        function fitToScreen() {
            const seatGridContainer = document.getElementById('seatGridContainer');
            const grid = document.getElementById('seatGrid');
            const zoomSlider = document.getElementById('zoomSlider');
            const zoomValue = document.getElementById('zoomValue');
            
            if (!seatGridContainer || !grid || !seatLayout.rows || !seatLayout.cols) return;

            // è¨ˆç®—åº§ä½è¡¨çš„å¯¦éš›å¤§å°
            const seatWidth = 120; // æ¯å€‹åº§ä½çš„å¯¬åº¦
            const seatHeight = 100; // æ¯å€‹åº§ä½çš„é«˜åº¦
            const gap = 10; // é–“è·
            const padding = 40; // å…§é‚Šè·
            
            const gridWidth = (seatWidth + gap) * seatLayout.cols - gap + padding;
            const gridHeight = (seatHeight + gap) * seatLayout.rows - gap + padding;
            
            // å–å¾—è¦–çª—å¤§å°ï¼ˆæ¸›å»ä¸€äº›é‚Šè·ï¼‰
            const viewportWidth = window.innerWidth - 100;
            const viewportHeight = window.innerHeight - 300;
            
            // è¨ˆç®—é©åˆçš„ç¸®æ”¾æ¯”ä¾‹
            const scaleX = viewportWidth / gridWidth;
            const scaleY = viewportHeight / gridHeight;
            const optimalScale = Math.min(scaleX, scaleY, 1) * 100; // ä¸è¶…é 100%
            
            // è¨­å®šç¸®æ”¾ï¼ˆæœ€å° 30%ï¼Œæœ€å¤§ 100%ï¼‰
            currentZoom = Math.max(30, Math.min(100, Math.floor(optimalScale / 5) * 5));
            
            if (zoomSlider && zoomValue) {
                zoomSlider.value = currentZoom;
                zoomValue.textContent = currentZoom + '%';
            }
            seatGridContainer.style.transform = `scale(${currentZoom / 100})`;
            localStorage.setItem('seatZoom', currentZoom);
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–ç¸®æ”¾æ§åˆ¶
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(initZoomControls, 500);
        });
        // ========== ç¸®æ”¾åŠŸèƒ½çµæŸ ==========
    </script>
</body>
</html>
